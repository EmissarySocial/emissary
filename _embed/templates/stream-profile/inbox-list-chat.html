{{- $inbox := .Inbox }}
{{- $folderID := .QueryParam "folderId" -}}
{{- $internalID := .QueryParam "origin.internalId" -}}

{{if gt (len $inbox) 0}}

	{{- $lastMessage := index $inbox (subtract (len $inbox) 1) -}}

	{{- range $inbox -}}

		<div 
			id="item_{{.MessageID.Hex}}" 
			class="message" 
			style="max-width:640px; cursor:pointer;" 
			hx-get="/@me/message?messageId={{.MessageID.Hex}}&origin.internalId={{$internalID}}"
			hx-push-url="true">

			<div class="flex-row" style="max-width:800px;">

				<div style="width:64px; flex-grow:0; flex-shrink:0;">
					<img src="{{.Document.Author.ImageURL}}" class="circle" style="width:64px;">
				</div>

				<div style="flex-grow:1;">

					<div class="ellipsis">
						<span class="bold black">{{.Document.Author.Name}}</span>
						<span class="text-gray nowrap">
							&nbsp;
							{{ icon .Origin.Icon }}
							{{ .PublishDate | tinyDate }}
						</span>
					</div>

					<div>
						{{- .Document.Summary | html -}}
					</div>

					{{- if ne .Document.ImageURL "" -}}
						<div class="space-above" style="max-width:400px; min-height:84px; border:solid 1px var(--gray20); background-color:var(--gray10);">
							<img src="{{.Document.ImageURL}}" loading="lazy" style="max-width:400x; max-height:300px; object-fit:cover;"/>
						</div>
					{{- end -}}

				</div>
			
			</div>

		</div>
	
		<hr>
		
	{{- end -}}

	<div 
		hx-get="/@me/inbox-list?folderId={{$folderID}}&origin.internalId={{$internalID}}&rank=GT:{{$lastMessage.Rank}}" 
		hx-push-url="false" 
		hx-trigger="intersect once" 
		hx-target="this" 
		hx-swap="outerHTML">
		<hr>
		<div><span class="spin">{{icon "loading"}}</span> Loading...</div>
	</div>

	<div
		hx-post="/@me/pub/folder/readDate?folderId={{$folderID}}&readDate={{$lastMessage.Rank}}"
		hx-push-url="false"
		hx-trigger="intersect once">
	</div>

{{- else -}}
	{{- template "inbox-empty" . -}}
{{- end -}}