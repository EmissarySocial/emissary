{{- $uri := .QueryParam "uri" -}}
{{- $publishedDate := .QueryParam "published" -}}

{{- $pageSize := 4 -}}
{{- $renderer := . -}}

{{- $replies := .RepliesBefore $uri $publishedDate $pageSize -}}

{{- if eq $replies.Length $pageSize -}}
	<div class="margin-bottom" role="button" hx-get="{{.BasePath}}/replies?uri={{$uri}}&published={{$replies.First.Published | epochDate}}" hx-target="this" hx-swap="outerHTML" hx-push-url="false">
		<span class="button text-xs">Show Older Replies</span>
	</div>
{{- end -}}

{{- range $index, $stream := $replies -}}

	{{- $object := $stream.UnwrapActivity -}}
	{{- $actor := $object.AttributedTo.Load -}}

	<div role="link"
		class="margin-bottom-lg"
		hx-get="/@me/inbox/message?uri={{$object.ID}}"
		hx-push-url="false"
		hx-target="#modal-window"
		hx-swap="innerHTML">

		<div class="flex-row">
			<div>
				{{- if $actor.Icon.IsNil -}}
					<div class="circle-48"></div>
				{{- else -}}
					<img class="circle-48" src="{{$actor.Icon.URL}}">
				{{- end -}}
			</div>
			<div class="flex-grow-1">
				{{- if $actor.NotNil -}}
					<div class="margin-right-sm">
						<span class="bold">{{$actor.Name}}</span>
						<span class="text-light-gray">@{{$actor.PreferredUsername}}</span>
					</div>
				{{- end -}}

				{{- if ne "" $object.Name -}}
					<div class="bold margin-top">{{$object.Name}}</div>
				{{- end -}}

				{{- if $object.Image.NotNil -}}
					<div class="margin-vertical"><img src="{{$object.Image.URL}}" class="width-100"></div>
				{{- end -}}
			
				<div>{{$object.Content | html}}</div>
				<div class="text-sm text-light-gray">
					{{ $object.Published | epochDate | tinyDate}} ago
					{{- $stats := $stream.Statistics -}}

					{{ if $stats.HasReplies }}
						&middot; {{$stats.Replies}} {{pluralize $stats.Replies "Reply" "Replies"}}
					{{ end }}

					{{ if $stats.HasLikes }}
						&middot; {{$stats.Likes}} {{pluralize $stats.Likes "Like" "Likes"}}
					{{ end }}

					{{ if $stats.HasAnnounces }}
						&middot; {{$stats.Announces}} {{pluralize $stats.Announces "Share" "Shares"}}
					{{ end }}

				</div>
			</div>

			{{- if $actor.NotNil -}}
				{{- if $renderer.NotMe $object.Actor.ID -}}
					<div class="align-right text-xs"
						hx-get="{{$renderer.BasePath}}/follow-button?url={{$object.Actor.ID}}"
						hx-swap="innerHTML"
						hx-target="this"
						hx-push-url="false"
						hx-trigger="load">
					</div>
				{{- end -}}
			{{- end -}}

		</div>
	</div>

{{- end -}}