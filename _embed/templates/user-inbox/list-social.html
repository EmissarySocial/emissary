{{- $inbox := .Inbox.Top12.ByPublishDate.Reverse.Slice -}}
{{- $folderID := .QueryParam "folderId" -}}
{{- $internalID := .QueryParam "origin.followingId" -}}

{{- if $inbox.NotEmpty -}}

	{{- $inboxBuilder := . -}}
	{{- range $index, $message := $inbox -}}

		{{- $document := $inboxBuilder.ActivityStream $message.URL -}}

		{{- if ne "" $document.ID -}}

			{{- $image := $document.ImageOrIcon -}}
			{{- $attributedTo := $document.AttributedTo -}}

			<hr class="noselect">
			<div 
				id="item_{{$message.ID}}" 
				class="message"
				style="max-width:640px"
				script="install blockselect()">
				
				<div script="install listItem(messageId:'{{$message.ID}}')">

					<span hx-get="/@me/inbox/browse?url={{$document.ID}}" hidden></span>

					{{- if eq "NEW-REPLIES" $message.StateID -}}
						<div class="flex-row">
							<div class="width-48 flex-shrink-0 margin-right-sm"></div>
							<div class="bold italics text-green text-sm">
								{{icon "chat-fill"}} New Replies
							</div>
						</div>
					{{- else if eq "MUTED" $message.StateID -}}
						<div class="flex-row">
							<div class="width-48 flex-shrink-0 margin-right-sm"></div>
							<div class="bold italics text-gray text-sm">
								{{icon "mute"}} Notifications Muted
							</div>
						</div>
					{{- else if ne "PRIMARY" $message.Origin.Type -}}
						<div class="flex-row">
							<div class="width-48 flex-shrink-0 margin-right-sm"></div>
							<div class="margin-bottom-sm">
								{{- template "message-origin" $message -}}
							</div>
						</div>
					{{- end -}}

					{{- if $attributedTo.NotEmpty -}}
						<div class="flex-row">
							<div class="width-48 flex-shrink-0 margin-right-sm noselect clickable">
								{{- if $attributedTo.Icon.NotNil -}}
									<img src="{{$attributedTo.Icon.Href}}" class="circle width-48">
								{{- else -}}
									<div class="circle width-48"></div>
								{{- end -}}
							</div>

							<div class="flex-grow">
								{{- if ne "" $attributedTo.Name -}}
									<div class="bold text-black"><span class="clickable">{{$attributedTo.Name}}</span></div>
									<div class="text-light-gray ellipsis">
										<span class="clickable">{{$attributedTo.UsernameOrID}}</span>
									</div>
								{{- end -}}
							</div>
						</div>
					{{- end -}}
					
					<div class="flex-row width-100% clickable margin-top-sm">
						<div class="width-48 flex-shrink-0 margin-right-sm noselect"></div>

						<div class="flex-grow">

							{{- if ne "" $document.Name -}}
								<div class="bold text-black">{{$document.Name}}</div>
							{{- end -}}

							<div class="margin-top" script="install showMore(maxHeight:240)">
								<div class="showMore-content">
									{{- if $document.HasContent -}}
										{{- $document.Content | htmlMinimal -}}
									{{- else if $document.HasSummary -}}
										{{- $document.Summary | htmlMinimal -}}
									{{- end }}
								</div>
								<div class="margin-vertical">
									<button class="text-xs showMore-button" hidden>Show More &hellip;</button>
								</div>
							</div>

							<div class="text-sm text-light-gray">
								{{ $message.PublishDate | tinyDate }} ago
							</div>

							{{- if $image.NotNil -}}
								<div class="margin-vertical">
									<img src="{{$image.Href}}" loading="lazy" class="rounded width-100% max-width-512" style="{{if $image.HasDimensions}}aspect-ratio:{{$image.AspectRatio}}{{end}}"/>
								</div>
							{{- end -}}

						</div>

					</div>

				</div>

				<div class="flex-row">
					<div class="width-48 flex-shrink-0 margin-right-sm"></div>
					<div>
						{{- $args := array $message $document $folderID $internalID -}}
						{{- template "message-responses" $args -}}
					</div>
				</div>

			</div>

		{{- end -}}
		
	{{- end -}}

	{{- $lastMessage := $inbox.Last -}}
	<div 
		hx-get="/@me/inbox/list?folderId={{$folderID}}&origin.followingId={{$internalID}}&rank=LT:{{$lastMessage.Rank}}&read=false&remote=true"
		hx-push-url="false" 
		hx-trigger="intersect once" 
		hx-target="this" 
		hx-swap="outerHTML">
		<div class="margin-vertical-lg text-sm"><button><span class="spin">{{icon "loading"}}</span> Loading...</button></div>
	</div>

{{- else -}}

	{{- if eq "" (.QueryParam "remote") -}}
		<h2 class="text-gray">This inbox is empty.  You can <span hx-get="/@me/settings/following-search?folderId={{$folderID}}" class="link">follow a new person</span> or website to add more.</h2>
	{{- end -}}

	<div style="height:100vw"></div>
{{- end -}}
