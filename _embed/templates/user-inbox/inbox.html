{{- $sidebar := .QueryParam "sidebar" -}}
{{- $folders := .FoldersWithSelection}}
{{- $folder := $folders.Selected -}}
{{- $filter := .FilteredByFollowing -}}

{{- $folderID := $folder.FolderID.Hex -}}
{{- $followingID := .QueryParam "origin.followingId" -}}

<div class="app width-100%" script="on load take .selected from .nav-item for #nav-inbox">

	<link rel="stylesheet" href="/.templates/user-inbox/stylesheet">

	<!-- Sidebar Content -->
	{{- if eq "collapse" $sidebar -}}
		{{- template "sidebar-collapsed" $folders -}}
	{{- else -}}
		{{- template "sidebar-expanded" $folders -}}
	{{- end -}}

	<!-- Main App Content -->
	<div class="app-content padding-top">

		<!-- Floating Menu Bar -->
		<div class="text-sm margin-none nowrap pos-sticky float-right" style="top:0px; padding:4px 0px 8px 16px; border-radius:4px; background-color:var(--page-background); view-transition-name:sticky-buttons">
			<button hx-get="/@me/settings/following-search?folderId={{$folderID}}" class="primary turboclick">{{icon "add"}} Source</button>
			{{- if $filter.IsZero -}}
				<button hx-get="/@me/inbox/filter?folderId={{$folderID}}" class="turboclick">{{icon "filter"}} Filter</button>
			{{- else -}}
				<button hx-get="/@me/inbox/filter?folderId={{$folderID}}&followingId={{$followingID}}" class="selected ellipsis turboclick" style="max-width:160px;">{{icon "filter-fill"}} {{$filter.Label}}</button>
			{{- end -}}
			<button hx-get="/@me/inbox/folder-edit?folderId={{$folderID}}" class="turboclick">{{icon "settings"}} Folder Settings</button>
		</div>

		<div class="flex-row margin-bottom-lg">

			{{- if $filter.NotZero -}}
				{{- $following := .FollowingByToken $followingID -}}
				<div class="flex-grow-1 margin-top-sm">
					<div class="bold"><a href="/@me/inbox?folderId={{$folderID}}" hx-get="/@me/inbox?folderId={{$folderID}}">{{iconFilled $folder.Icon}} {{$folder.Label}}</a></div>
					<div class="flex-row margin-vertical">
						{{- if ne "" $following.IconURL -}}
							<div class="margin-top-xs">
								<img src="{{$following.IconURL}}" class="circle width-48">
							</div>
						{{- end -}}

						<div>
							<h1 class="margin-top-none margin-bottom-sm ellipsis-block">
								{{$following.Label}}
							</h1>
							<div class="margin-none">
								<a href="{{$following.URL}}" target="_blank" class="text-gray">{{$following.URL}}</a>
								&middot; {{$following.LastPolled | tinyDate}} ago
								&nbsp;
								<button class="text-xs" hx-get="/@me/settings/following-edit?followingId={{$following.FollowingID.Hex}}">Edit Source</button>
							</div>
						</div>
					</div>
				</div>
			{{- else -}}
				<h1 class="text-xl bold margin-none flex-grow">{{iconFilled $folder.Icon}} {{$folder.Label}}</h1>
			{{- end -}}
		</div>

		{{- template "list" . -}}
	
	</div>

	<script src="/.templates/user-inbox/hyperscript" type="text/hyperscript"></script>

	<div
		hx-get="{{.URL}}" 
		hx-trigger="refreshPage from:window"
		hx-target="main"
		hx-swap="innerHTML"
		hx-push-url="false">
	</div>
	
</div>