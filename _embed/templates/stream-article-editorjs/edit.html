<div class="page">

	<div id="menu-bar">
		<div class="left">
			{{- if .UserCan "edit" -}}
				<a hx-get="/{{.StreamID}}/edit" class="bold">Content</a>
			{{- end -}}

			{{- if .UserCan "widgets" -}}
				<a hx-get="/{{.StreamID}}/widgets" hx-push-url="true">Widgets</a>
			{{- end -}}

			{{- if .UserCan "properties" -}}
				<a hx-get="/{{.StreamID}}/properties">Info</a>
			{{- end -}}

			{{- if .UserCan "sharing" -}}
				<a hx-get="/{{.StreamID}}/sharing">Sharing</a>
			{{- end -}}
		</div>

		<div class="right">
			<button script="on click saveDraft(true)" class="button primary">Promote</button>
			<button script="on click saveDraft(false)">Save Draft</button>
			<button hx-get="/{{.StreamID}}/discard-draft">Discard Draft</button>

			{{- if .UserCan "delete" -}}
				<a hx-get="/{{.StreamID}}/delete" class="text-red">Delete</a>
			{{- end -}}
		</div>

	</div>

	<div hx-get="/{{.StreamID}}/heading" hx-trigger="refreshPage">
		{{.View "heading"}}
	</div>

	<article id="content-editor" data-content="{{.ContentRaw}}"></article>
	
</div>

<script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/paragraph@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/header@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/list@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/link@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/embed@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/image@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/attaches@latest"></script>

<script>
	
	var editor = new EditorJS({
		holder: "content-editor",
		data: JSON.parse(document.getElementById("content-editor").getAttribute("data-content")),
		tools: {
			paragraph: {
				class: Paragraph,
				inlineToolbar: true,
			},
			header: {
				class: Header,
				inlineToolbar: ['link'],
				config: {
					placeholder: 'Header',
					levels: [1, 2, 3],
					defaultLevel: 2,
				},
			},
			list: {
				class: List,
				inlineToolbar: true,
				config: {
					placeholder: 'List',
				},
			},
			linkTool: {
				class: LinkTool,
				config: {
				// endpoint: 'http://localhost:8008/fetchUrl', // Your backend endpoint for url data fetching,
				}
			},
			embed: {
				class: Embed,
				config: {
				}
			},
			image: {
				class: ImageTool,
				config: {
					endpoints: {
						byFile: '/{{.StreamID}}/upload-image', // Your backend file uploader endpoint
						byUrl: '/{{.StreamID}}/upload-image', // Your endpoint that provides uploading by Url
					}
				}
			},
			attaches: {
				class: AttachesTool,
				config: {
					endpoint: 'http://localhost:8008/uploadFile'
				}
			}
		},
	})

	async function saveDraft(promote) {
		// Get the content from the editor
		content = await editor.save()

		// POST the content to the server
		await fetch("{{.URL}}", {
			method: "POST",
			body: JSON.stringify(content),
		})

		// Maybe Promote the draft
		if (promote) {
			await fetch("/{{.StreamID}}/promote-draft", {
				method: "POST"
			})
		}

		// Redirect to the top of the page.
		window.location = "/{{.StreamID}}"
	}
</script>