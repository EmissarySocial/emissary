{{- $isDesktop := .IsDesktop -}}
{{- $imports := .Imports -}}

<div class="app" script="init send SelectNav(id:'settings')">
	<title>Import/Export | {{.DisplayName}}</title>

	{{- if $isDesktop -}}
		<div id="app-sidebar" class="expanded">
			{{- template "menu" "migration" -}}
		</div>
	{{- end -}}
	
	<div class="app-content padding">

		<div id="menu-bar">
			<div class="left">
				{{ if not $isDesktop }}
					<a href="/@me/settings/mobile">{{icon "back"}}</a>
				{{ end }}
				<a href="/@me/settings/import" class="selected">Import</a>
				<a href="/@me/settings/export">Export</a>
			</div>
			<div class="right">
				<a href="https://emissary.dev/migration" target="_blank" class="link">
					{{icon "help"}}
					{{ if $isDesktop }} Help with Data Migration {{ end }}
				</a>
			</div>
		</div>

		<div class="margin-bottom-xl">
			<div class="card padding" style="max-width:600px">
				
				{{- $import := $imports.First -}}
				{{- $source := .ActivityStream $import.SourceID -}}

				{{- if $source.NotNil -}}
					
					<div class="text-lg bold margin-top-none margin-bottom-sm">Importing From</div>
					<div class="margin-bottom-lg flex-row">
						<div>
							<img src="{{$source.Icon.Href}}" class="width-48 circle">
						</div>
						<div>
							<div class="text-bold">{{$source.Name}} (@{{$source.Username}})</div>
							<div><a href="{{$source.URL}}" class="text-nocolor text-gray" target="_blank">{{$source.URL}} &nbsp;{{icon "link-outbound"}}</a></div>
						</div>
					</div>
				{{- end -}}

				{{- if $imports.IsEmpty -}}

					<div class="text-lg bold">{{icon "cloud"}} Online Profile Import</div>

					<div>
						You can import all of your profile data directly another Fediverse server.
						Here are the steps we'll take:
					</div>
					<ol>
						<li>Authenticate your account on your original server (OAuth)</li>
						<li>Import all data that we are able to import.</li>
						<li>Manually review your profile.</li>
						<li>Officially &quot;Move&quot; your account and announce to your followers</li>
					</ol>

					<div class="margin-bottom">
						<i>Note: online account migration is new, and very few servers support
						this action right now.</i>
						<a href="https://emissary.dev/migration" target="_blank">Learn More {{icon "link-outbound"}}</a>
					</div>

					<button hx-get="/@me/settings/import-authenticate" class="primary">Start an Import...</button>

				{{- else if eq "AUTHORIZATION-ERROR" $import.StateID -}}

					<div class="flex-row flex-align-start">
						<div class="text-lg text-red">{{icon "alert"}}</div>
						<div>
							<div class="bold text-red text-lg">Your Import Could Not Be Started</div>
							<div>{{$import.ErrorMessage}}</div>
							<div class="margin-top">
								<button class="primary" hx-get="/@me/settings/import-authenticate?importId={{$import.ID}}">Edit Account</button>
								<button hx-get="/@me/settings/import-delete?importId={{$import.ID}}">Cancel Import</button>
							</div>
						</div>
					</div>

				{{- else if eq "AUTHORIZING" $import.StateID -}}

					<div class="text-lg bold">Waiting for Approval</div>
					<div class="margin-bottom">
						We have not received approval from remote account yet. This can happen when you cancel
						the authentication process on your remote account. To continue, please reconnect to 
						the remote server.
					</div>
					<div>
						<a href="{{$import.OAuthCodeURL}}" class="button primary">Approve Now</a>
						<button hx-get="/@me/settings/import-delete?importId={{$import.ID}}">Cancel Import</button>
					</div>

				{{- else if eq "AUTHORIZED" $import.StateID -}}

					{{- $importPlan := .ImportPlan $source -}}

					{{- if $importPlan.NotEmpty -}}

						<div class="text-lg text-green bold">Ready to Import</div>
						<div class="margin-bottom">
							Click the button below to start importing your profile information from {{$source.URL | domainOnly}}.
							Here are all of the records we are able to import:
						</div>
						<table class="table">
							{{- range $index, $item := $importPlan -}}
								<tr>
									<td class="text-green text-lg margin-none">{{icon $item.Icon}}</td>
									<td>
										<div>
											<span class="bold margin-right-sm">{{$item.Label}}</span>
											<span class="text-xs text-gray text-bold text-uppercase">
												
												{{$item.Group}}
											</span>
										</div>
										<div>{{$item.Description}}</div>
										
									</td>
								</tr>
							{{- end -}}
						</table>

						<div class="margin-bottom-lg">
							Once this process is complete, you will have the opportunity 
							to review your imported profile data <i>before</i> permanently 
							moving your account to this server.
						</div>
						<div>
							<button hx-post="/@me/settings/import-start?importId={{$import.ID}}" class="primary success">Start Import</button>
							<button hx-get="/@me/settings/import-delete?importId={{$import.ID}}">Cancel Import</button>
						</div>

					{{- else -}}
						<div class="text-lg bold">No Importable Data</div>
						<div class="margin-bottom">
							This account does not publish any data that we can import.
							Contact your system administrator for assistance.
						</div>
						<div>
							<button hx-get="/@me/settings/import-delete?importId={{$import.ID}}">Cancel Import</button>
						</div>
					{{- end -}}

				{{- else -}}
					<pre>{{$import |jsonIndent}}</pre>
				{{- end -}}
			</div>
		</div>
				
	</div>

	<div 
		hx-get="{{.URL}}" 
		hx-trigger="refreshPage from:window" 
		hx-target="main"
		hx-swap="innerHTML"
		hx-push-url="false">
	</div>

</div>